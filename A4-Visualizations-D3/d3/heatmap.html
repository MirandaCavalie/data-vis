<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Heatmap in D3</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 20px;
    }
    .back-link {
      align-self: flex-start;
      max-width: 860px;
      width: 100%;
      margin: 0 auto 15px auto;
      font-size: 14px;
    }
    .back-link a { color: steelblue; text-decoration: none; }
    .back-link a:hover { text-decoration: underline; }
    .chart-container {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 30px;
      max-width: 860px;
      width: 100%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    h1 { color: #2c3e50; font-size: 1.4rem; margin-bottom: 4px; }
    .subtitle { font-size: 0.85rem; color: #777; margin-bottom: 20px; }
    .axis text { fill: #555; font-family: Arial, sans-serif; font-size: 12px; }
    .axis path, .axis line { stroke: none; }
    .axis-label { fill: #555; font-size: 13px; font-family: Arial, sans-serif; }
    .cell { cursor: pointer; }
    .cell:hover { stroke: #2c3e50; stroke-width: 2; }
    .cell-label { fill: #2c3e50; font-size: 13px; font-weight: bold; font-family: Arial, sans-serif; pointer-events: none; }
    .tooltip {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 8px 12px;
      font-size: 13px;
      color: #333;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      box-shadow: 0 3px 12px rgba(0,0,0,0.12);
      font-family: Arial, sans-serif;
    }
    .tooltip strong { color: steelblue; }
    .legend-bar { display: flex; align-items: center; gap: 8px; margin-top: 14px; }
    .legend-label { font-size: 12px; color: #777; }
  </style>
</head>
<body>
  <div class="back-link"><a href="../index.html">← Back to A4</a></div>
  <div class="chart-container">
    <h1>Heatmap: Average Screen Time by Age Group &amp; Device</h1>
    <p class="subtitle">Average daily total screen time (hours) — 6 age groups × 3 primary devices</p>
    <div id="chart"></div>
    <div class="legend-bar">
      <span class="legend-label">Lower</span>
      <svg id="color-bar" width="180" height="12"></svg>
      <span class="legend-label">Higher</span>
    </div>
  </div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const margin = {top: 10, right: 25, bottom: 55, left: 80};
    const width = 760 - margin.left - margin.right;
    const height = 370 - margin.top - margin.bottom;

    const svg = d3.select("#chart")
      .append("svg")
      .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
      .attr("preserveAspectRatio", "xMidYMid meet")
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select("#tooltip");

    const ageOrder = ["13-18", "19-25", "26-35", "36-45", "46-60", "60+"];
    const deviceOrder = ["Mobile", "Tablet", "Laptop"];

    d3.csv("../data/daily_usage.csv").then(data => {
      data.forEach(d => { d.total_screen_time = +d.total_screen_time; });

      //aggreagate d3.rollup for agregation
      const grouped = d3.rollup(data,
        v => ({ avg: d3.mean(v, d => d.total_screen_time), count: v.length }),
        d => d.age_group,
        d => d.primary_device
      );

      const heatData = [];
      ageOrder.forEach(age => {
        deviceOrder.forEach(device => {
          const entry = grouped.get(age)?.get(device);
          if (entry) {
            heatData.push({ age_group: age, device: device, avg: entry.avg, count: entry.count });
          }
        });
      });

      const x = d3.scaleBand().domain(deviceOrder).range([0, width]).padding(0.08);
      const y = d3.scaleBand().domain(ageOrder).range([0, height]).padding(0.08);

      const colorScale = d3.scaleSequential()
        .domain(d3.extent(heatData, d => d.avg))
        .interpolator(d3.interpolateYlOrRd);

      svg.append("g")
        .attr("class", "axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).tickSize(0))
        .selectAll("text").attr("dy", "1em").style("font-size", "13px");

      svg.append("g")
        .attr("class", "axis")
        .call(d3.axisLeft(y).tickSize(0))
        .selectAll("text").style("font-size", "13px");

      svg.append("text")
        .attr("class", "axis-label")
        .attr("x", width / 2)
        .attr("y", height + 46)
        .attr("text-anchor", "middle")
        .text("Primary Device");

      svg.append("text")
        .attr("class", "axis-label")
        .attr("x", -height / 2)
        .attr("y", -65)
        .attr("text-anchor", "middle")
        .attr("transform", "rotate(-90)")
        .text("Age Group");

        //animation:
      svg.selectAll(".cell")
        .data(heatData)
        .join("rect")
        .attr("class", "cell")
        .attr("x", d => x(d.device))
        .attr("y", d => y(d.age_group))
        .attr("width", x.bandwidth())
        .attr("height", y.bandwidth())
        .attr("rx", 4)
        .attr("fill", "#eee")
        .on("mouseover", (event, d) => {
          tooltip.style("opacity", 1)
            .html(`<strong>${d.age_group} / ${d.device}</strong><br>Avg Screen Time: ${d.avg.toFixed(2)}h<br>Records: ${d.count}`);
        })
        .on("mousemove", event => {
          tooltip.style("left", (event.pageX + 12) + "px")
            .style("top", (event.pageY - 40) + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0))
        .transition()
        .duration(700)
        .delay((d, i) => i * 50)
        .attr("fill", d => colorScale(d.avg));

      svg.selectAll(".cell-label")
        .data(heatData)
        .join("text")
        .attr("class", "cell-label")
        .attr("x", d => x(d.device) + x.bandwidth() / 2)
        .attr("y", d => y(d.age_group) + y.bandwidth() / 2 + 5)
        .attr("text-anchor", "middle")
        .attr("opacity", 0)
        .text(d => d.avg.toFixed(1) + "h")
        .transition()
        .duration(400)
        .delay((d, i) => i * 50 + 500)
        .attr("opacity", 1);

      const barSvg = d3.select("#color-bar");
      const defs = barSvg.append("defs");
      const gradient = defs.append("linearGradient").attr("id", "heatGrad");
      gradient.append("stop").attr("offset", "0%").attr("stop-color", colorScale(colorScale.domain()[0]));
      gradient.append("stop").attr("offset", "100%").attr("stop-color", colorScale(colorScale.domain()[1]));
      barSvg.append("rect").attr("width", 180).attr("height", 12).attr("rx", 3).attr("fill", "url(#heatGrad)");
    });
  </script>
</body>
</html>
