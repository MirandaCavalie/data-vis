<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bubble Chart in D3</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 20px;
    }
    .back-link {
      align-self: flex-start;
      max-width: 920px;
      width: 100%;
      margin: 0 auto 15px auto;
      font-size: 14px;
    }
    .back-link a { color: steelblue; text-decoration: none; }
    .back-link a:hover { text-decoration: underline; }
    .chart-container {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 30px;
      max-width: 920px;
      width: 100%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    h1 { color: #2c3e50; font-size: 1.4rem; margin-bottom: 4px; }
    .subtitle { font-size: 0.85rem; color: #777; margin-bottom: 20px; }
    .axis text { fill: #555; font-family: Arial, sans-serif; font-size: 12px; }
    .axis path, .axis line { stroke: #ccc; }
    .axis-label { fill: #555; font-size: 13px; font-family: Arial, sans-serif; }
    .bubble { cursor: pointer; }
    .tooltip {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 8px 12px;
      font-size: 13px;
      color: #333;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      box-shadow: 0 3px 12px rgba(0,0,0,0.12);
      font-family: Arial, sans-serif;
    }
    .tooltip strong { color: steelblue; }
    .legends-row {
      display: flex;
      gap: 40px;
      margin-top: 14px;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .legend-block h4 {
      font-size: 12px;
      color: #555;
      margin-bottom: 4px;
      font-weight: bold;
    }
    .legendCells text { font-size: 12px !important; fill: #555; font-family: Arial, sans-serif; }
  </style>
</head>
<body>
  <div class="back-link"><a href="index.html">← Back to A5</a></div>
  <div class="chart-container">
    <h1>Daily Screen Time — Bubble Chart</h1>
    <p class="subtitle">
      Work/Study Hours vs. Entertainment Hours &nbsp;·&nbsp;
      size = Total Screen Time &nbsp;·&nbsp;
      color = Age Group &nbsp;·&nbsp; 500 sampled users
    </p>
    <div id="chart"></div>
    <div class="legends-row">
      <div class="legend-block">
        <h4>Age Group (Color)</h4>
        <svg id="color-legend" width="130" height="152"></svg>
      </div>
      <div class="legend-block">
        <h4>Total Screen Time (Size)</h4>
        <svg id="size-legend" width="170" height="152"></svg>
      </div>
    </div>
  </div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const margin = { top: 20, right: 30, bottom: 58, left: 65 };
    const width  = 840 - margin.left - margin.right;
    const height = 470 - margin.top  - margin.bottom;

    const svg = d3.select("#chart")
      .append("svg")
      .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
      .attr("preserveAspectRatio", "xMidYMid meet")
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select("#tooltip");

    const ageOrder   = ["13-18", "19-25", "26-35", "36-45", "46-60", "60+"];
    const colorScale = d3.scaleOrdinal()
      .domain(ageOrder)
      .range(["#e74c3c", "#e67e22", "#27ae60", "#4682B4", "#8e44ad", "#2c3e50"]);

    d3.csv("data/daily_usage.csv").then(data => {
      data.forEach(d => {
        d.work_or_study_hours = +d.work_or_study_hours;
        d.entertainment_hours = +d.entertainment_hours;
        d.social_media_hours  = +d.social_media_hours;
        d.total_screen_time   = +d.total_screen_time;
      });

      const sampled = d3.shuffle(data.slice()).slice(0, 500);

      const x = d3.scaleLinear()
        .domain([0, d3.max(sampled, d => d.work_or_study_hours) * 1.05]).nice()
        .range([0, width]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(sampled, d => d.entertainment_hours) * 1.05]).nice()
        .range([height, 0]);

      const sizeScale = d3.scaleSqrt()
        .domain(d3.extent(sampled, d => d.total_screen_time))
        .range([3, 16]);

      svg.append("g")
        .call(d3.axisLeft(y).ticks(6).tickSize(-width).tickFormat(""))
        .call(g => g.select(".domain").remove())
        .call(g => g.selectAll("line").attr("stroke", "#e8e8e8"));

      svg.append("g")
        .call(d3.axisBottom(x).ticks(8).tickSize(-height).tickFormat(""))
        .attr("transform", `translate(0,${height})`)
        .call(g => g.select(".domain").remove())
        .call(g => g.selectAll("line").attr("stroke", "#e8e8e8"));

      svg.append("g").attr("class", "axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(8).tickFormat(d => d + "h"));

      svg.append("g").attr("class", "axis")
        .call(d3.axisLeft(y).ticks(6).tickFormat(d => d + "h"))
        .call(g => g.select(".domain").remove());

      svg.append("text").attr("class", "axis-label")
        .attr("x", width / 2).attr("y", height + 48)
        .attr("text-anchor", "middle")
        .text("Work / Study Hours (daily)");

      svg.append("text").attr("class", "axis-label")
        .attr("x", -height / 2).attr("y", -50)
        .attr("text-anchor", "middle").attr("transform", "rotate(-90)")
        .text("Entertainment Hours (daily)");

      svg.selectAll(".bubble")
        .data(sampled)
        .join("circle")
        .attr("class", "bubble")
        .attr("cx", d => x(d.work_or_study_hours))
        .attr("cy", d => y(d.entertainment_hours))
        .attr("r",  d => sizeScale(d.total_screen_time))
        .attr("fill", d => colorScale(d.age_group))
        .attr("opacity", 0.62)
        .attr("stroke", "#fff")
        .attr("stroke-width", 0.6)
        .on("mouseover", (event, d) => {
          tooltip.style("opacity", 1).html(
            `<strong>Age Group: ${d.age_group}</strong><br>` +
            `Work/Study: ${d.work_or_study_hours}h<br>` +
            `Entertainment: ${d.entertainment_hours}h<br>` +
            `Social Media: ${d.social_media_hours}h<br>` +
            `Total Screen Time: ${d.total_screen_time}h`
          );
          d3.select(event.target).attr("opacity", 1).attr("stroke", "#333").attr("stroke-width", 1.5);
        })
        .on("mousemove", event => {
          tooltip.style("left", (event.pageX + 12) + "px").style("top", (event.pageY - 40) + "px");
        })
        .on("mouseout", event => {
          tooltip.style("opacity", 0);
          d3.select(event.target).attr("opacity", 0.62).attr("stroke", "#fff").attr("stroke-width", 0.6);
        });

      const colorLegend = d3.legendColor()
        .scale(colorScale)
        .shape("circle")
        .shapeRadius(7)
        .shapePadding(5)
        .labelOffset(8);

      d3.select("#color-legend").append("g")
        .attr("transform", "translate(10,10)")
        .call(colorLegend);

      const sizeLegend = d3.legendSize()
        .scale(sizeScale)
        .shape("circle")
        .cells([5, 8, 11, 14])
        .shapePadding(10)
        .labelOffset(8)
        .labelFormat(d => d + "h");

      d3.select("#size-legend").append("g")
        .attr("transform", "translate(24,14)")
        .call(sizeLegend);
    });
  </script>
</body>
</html>
